<div class="min-h-screen w-full bg-gray-50" data-controller="shipment-details">
  <!-- Header: Shipment Identifier -->
  <div class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center">
          <%= link_to shipments_path, class: "flex items-center text-gray-600 hover:text-gray-900 mr-6" do %>
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back to Shipments
          <% end %>
          <div class="h-6 w-px bg-gray-300 mr-6"></div>
          <h1 class="text-2xl font-bold text-gray-900"><%= @shipment.shipment_identifier %></h1>
        </div>
        <div class="flex items-center space-x-4">
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
            <%= case @shipment.current_status
                when 'delivered' then 'bg-green-100 text-green-800'
                when 'in_transit' then 'bg-blue-100 text-blue-800'
                when 'out_for_delivery' then 'bg-yellow-100 text-yellow-800'
                when 'prepared' then 'bg-gray-100 text-gray-800'
                when 'picked_up' then 'bg-purple-100 text-purple-800'
                when 'exception' then 'bg-red-100 text-red-800'
                else 'bg-gray-100 text-gray-800'
                end %>">
            <%= @shipment.current_status.humanize %>
          </span>
          
          <!-- Simulation Controls -->
          <div class="flex space-x-2">
            <%= button_to "Simulate Update", 
                simulate_update_shipment_path(@shipment), 
                method: :post, 
                class: "bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors",
                confirm: "Send a single location update for this shipment?" %>
            
            <%= button_to "Start Simulation", 
                start_simulation_shipment_path(@shipment), 
                method: :post, 
                class: "bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors",
                confirm: "Start continuous GPS simulation for this shipment?" %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column: Metadata, Tabs, and Lists -->
      <div class="lg:col-span-1 space-y-6">
        <!-- Metadata Section -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Package Details</h2>
          </div>
          <div class="px-6 py-4 space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <dt class="text-sm font-medium text-gray-500">Weight</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= @shipment.weight %> kg</dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Height</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= @shipment.height %> m</dd>
              </div>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Source</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= @shipment.source_address %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Destination</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= @shipment.destination_address %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Current Status</dt>
              <dd class="mt-1">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                  <%= case @shipment.current_status
                      when 'delivered' then 'bg-green-100 text-green-800'
                      when 'in_transit' then 'bg-blue-100 text-blue-800'
                      when 'out_for_delivery' then 'bg-yellow-100 text-yellow-800'
                      when 'prepared' then 'bg-gray-100 text-gray-800'
                      when 'picked_up' then 'bg-purple-100 text-purple-800'
                      when 'exception' then 'bg-red-100 text-red-800'
                      else 'bg-gray-100 text-gray-800'
                      end %>">
                  <%= @shipment.current_status.humanize %>
                </span>
              </dd>
            </div>
          </div>
        </div>

        <!-- Tabs: Status History | Location Trail -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
          <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
              <button data-action="click->shipment-details#switchTab" 
                      data-tab="status-history"
                      class="tab-button py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200 border-blue-500 text-blue-600">
                Status History
              </button>
              <button data-action="click->shipment-details#switchTab" 
                      data-tab="location-trail"
                      class="tab-button py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                Location Trail
              </button>
            </nav>
          </div>

          <!-- Status History Tab Content -->
          <div id="status-history" class="tab-content">
            <div class="px-6 py-4 max-h-96 overflow-y-auto">
              <div class="space-y-4">
                <% @shipment.shipment_status_histories.order(:changed_at).each_with_index do |status, index| %>
                  <div class="flex items-start cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors duration-150"
                       data-action="click->shipment-details#centerOnStatus"
                       data-latitude="<%= status.latitude %>"
                       data-longitude="<%= status.longitude %>"
                       data-status="<%= status.status %>">
                    <div class="flex-shrink-0">
                      <div class="w-3 h-3 rounded-full mt-1.5
                        <%= case status.status
                            when 'delivered' then 'bg-green-500'
                            when 'in_transit' then 'bg-blue-500'
                            when 'out_for_delivery' then 'bg-yellow-500'
                            when 'prepared' then 'bg-gray-500'
                            when 'picked_up' then 'bg-purple-500'
                            when 'exception' then 'bg-red-500'
                            else 'bg-gray-500'
                            end %>">
                      </div>
                    </div>
                    <div class="ml-4 flex-1 min-w-0">
                      <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-gray-900"><%= status.status.humanize %></p>
                        <p class="text-xs text-gray-500"><%= status.changed_at.strftime("%m/%d %H:%M") %></p>
                      </div>
                      <p class="text-sm text-gray-600 mt-1"><%= status.address %></p>
                      <% if status.notes.present? %>
                        <p class="text-xs text-gray-500 mt-1 italic"><%= status.notes %></p>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>

          <!-- Location Trail Tab Content -->
          <div id="location-trail" class="tab-content hidden">
            <div class="px-6 py-4 max-h-96 overflow-y-auto">
              <div class="space-y-3">
                <% @shipment.shipment_locations.order(:recorded_at).each_with_index do |location, index| %>
                  <div class="flex items-start cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors duration-150"
                       data-action="click->shipment-details#highlightLocation"
                       data-latitude="<%= location.latitude %>"
                       data-longitude="<%= location.longitude %>"
                       data-index="<%= index %>">
                    <div class="flex-shrink-0">
                      <div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                    </div>
                    <div class="ml-4 flex-1 min-w-0">
                      <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-gray-900">Point <%= index + 1 %></p>
                        <p class="text-xs text-gray-500"><%= Time.at(location.recorded_at).strftime("%m/%d %H:%M") %></p>
                      </div>
                      <p class="text-sm text-gray-600 mt-1"><%= location.address %></p>
                      <div class="flex items-center mt-1 space-x-4">
                        <span class="text-xs text-gray-500">
                          <%= location.latitude %>, <%= location.longitude %>
                        </span>
                        <% if location.speed && location.speed > 0 %>
                          <span class="text-xs text-gray-500">
                            <%= location.speed.round(1) %> km/h
                          </span>
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Google Map -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Route Visualization</h2>
          </div>
          <div class="p-4">
            <div id="map" 
                 class="h-96 w-full rounded-lg" 
                 data-shipment-details-target="map"
                 data-shipment-details-status-histories-value="<%= @shipment.shipment_status_histories.to_json %>"
                 data-shipment-details-locations-value="<%= @shipment.shipment_locations.to_json %>"></div>
            
            <!-- Map Legend -->
            <div class="mt-4 grid grid-cols-2 gap-4 text-xs">
              <div class="space-y-2">
                <h3 class="font-medium text-gray-700">Route Elements</h3>
                <div class="flex items-center space-x-2">
                  <div class="w-4 h-0.5 bg-blue-600"></div>
                  <span class="text-gray-600">Route with directional arrows</span>
                </div>
                <div class="flex items-center space-x-2">
                  <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                  <span class="text-gray-600">Current location</span>
                </div>
              </div>
              <div class="space-y-2">
                <h3 class="font-medium text-gray-700">Status Changes</h3>
                <div class="flex items-center space-x-2">
                  <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                  <span class="text-gray-600">In Transit</span>
                </div>
                <div class="flex items-center space-x-2">
                  <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                  <span class="text-gray-600">Delivered</span>
                </div>
                <div class="flex items-center space-x-2">
                  <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                  <span class="text-gray-600">Out for Delivery</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
